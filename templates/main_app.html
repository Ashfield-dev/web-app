{% extends "base.html" %}

{% block content %}
<div class="user-info-bar">
    Logged in as: <strong>{{ user_info }}</strong>
    <a href="{{ url_for('disconnect') }}" class="btn btn-danger btn-sm float-right">Disconnect Session</a>
</div>

<div class="main-box">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="download-tab" data-toggle="tab" href="#download" role="tab" aria-controls="download" aria-selected="true">Download</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="upload-tab" data-toggle="tab" href="#upload" role="tab" aria-controls="upload" aria-selected="false">Upload</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="csv-tab" data-toggle="tab" href="#csv" role="tab" aria-controls="csv" aria-selected="false">Auto CSV</a>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <!-- Download Tab -->
        <div class="tab-pane fade show active p-3" id="download" role="tabpanel" aria-labelledby="download-tab">
            <div class="section-title">Download From Link</div>
            <form method="POST" action="{{ url_for('download_from_link_route') }}">
                <div class="form-group">
                    <label for="download_link">Input Link</label>
                    <input type="url" class="form-control" id="download_link" name="download_link" placeholder="Put Link Here..." required>
                </div>
                <button type="submit" class="btn btn-primary">Download</button>
            </form>
            {% if session.download_progress is defined and session.download_progress >= 0 %}
            <label class="mt-3">Download Progress:</label>
            <div class="progress">
                <div class="progress-bar {% if session.download_progress == 100 %}bg-success{% else %}bg-info progress-bar-striped progress-bar-animated{% endif %}" role="progressbar" style="width: {{ session.download_progress }}%;" aria-valuenow="{{ session.download_progress }}" aria-valuemin="0" aria-valuemax="100">{{ session.download_progress|round|int }}%</div>
            </div>
            {% elif session.download_progress == -1 %}
             <div class="alert alert-danger mt-2" role="alert">Download failed. Check logs.</div>
            {% endif %}
        </div>

        <!-- Upload Tab -->
        <div class="tab-pane fade p-3" id="upload" role="tabpanel" aria-labelledby="upload-tab">
            <div classs="section-title">Upload To Telegram (Saved Messages)</div>
            <form method="POST" action="{{ url_for('upload_file_route') }}">
                <div class="form-group">
                    <label for="file_to_upload">Choose File From Downloads (<code>{{ DOWNLOAD_FOLDER_UI_basename }}/</code>)</label>
                    {% if downloaded_files %}
                        <select class="form-control" id="file_to_upload" name="file_to_upload">
                            {% for file in downloaded_files %}
                            <option value="{{ file }}">{{ file }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <p class="text-muted">No files found in downloads folder yet.</p>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="caption">Caption (optional)</label>
                    <input type="text" class="form-control" id="caption" name="caption" placeholder="Enter caption...">
                </div>
                <button type="submit" class="btn btn-info" {% if not downloaded_files %}disabled{% endif %}>Upload to Saved Messages</button>
            </form>
             {% if session.upload_progress is defined and session.upload_progress >= 0 %}
            <label class="mt-3">Upload Progress:</label>
            <div class="progress">
                <div class="progress-bar {% if session.upload_progress == 100 %}bg-success{% else %}bg-info progress-bar-striped progress-bar-animated{% endif %}" role="progressbar" style="width: {{ session.upload_progress }}%;" aria-valuenow="{{ session.upload_progress }}" aria-valuemin="0" aria-valuemax="100">{{ session.upload_progress|round|int }}%</div>
            </div>
            {% elif session.upload_progress == -1 %}
             <div class="alert alert-danger mt-2" role="alert">Upload failed. Check logs.</div>
            {% endif %}
        </div>

        <!-- Auto CSV Tab -->
        <div class="tab-pane fade p-3" id="csv" role="tabpanel" aria-labelledby="csv-tab">
            <div class="section-title">Automatic Download-Upload From CSV</div>
            <form method="POST" action="{{ url_for('process_csv_route') }}" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="csv_file">Choose CSV File (columns: 'link'; 'caption' [optional])</label>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="csv_file" name="csv_file" accept=".csv" required>
                        <label class="custom-file-label" for="csv_file">Choose file...</label>
                    </div>
                    <small class="form-text text-muted">Ensure CSV uses semicolon (;) as delimiter.</small>
                </div>
                <button type="submit" class="btn btn-success">Run CSV Process</button>
            </form>
            {% if session.csv_overall_progress is defined and session.csv_overall_progress >= 0 %}
            <label class="mt-3">CSV Overall Progress:</label>
            <div class="progress">
                 <div class="progress-bar {% if session.csv_overall_progress == 100 %}bg-success{% else %}bg-info progress-bar-striped progress-bar-animated{% endif %}" role="progressbar" style="width: {{ session.csv_overall_progress }}%;" aria-valuenow="{{ session.csv_overall_progress }}" aria-valuemin="0" aria-valuemax="100">{{ session.csv_overall_progress|round|int }}%</div>
            </div>
            {% elif session.csv_overall_progress == -1 %}
             <div class="alert alert-danger mt-2" role="alert">CSV processing failed. Check logs.</div>
            {% endif %}
            <div id="csv_status_text" class="status-box mt-2">
                {% if request.args.get('csv_status') %} {{ request.args.get('csv_status') }} {% else %} Awaiting CSV processing... {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Show filename in custom file input
    document.querySelectorAll('.custom-file-input').forEach(function(input) {
        input.addEventListener('change', function(e) {
            var fileName = e.target.files[0].name;
            var nextSibling = e.target.nextElementSibling;
            nextSibling.innerText = fileName;
        });
    });

    // Persist active tab using localStorage
    $(document).ready(function(){
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            localStorage.setItem('lastTab', $(this).attr('href'));
        });
        var lastTab = localStorage.getItem('lastTab');
        if (lastTab) {
            $('[href="' + lastTab + '"]').tab('show');
        } else {
            // Default to first tab if no tab stored
            $('a[data-toggle="tab"]:first').tab('show');
        }
    });
</script>
{% endblock %}